//
//  Tests.m
//  Tests
//
//  Created by Georg Seifert on 09.11.19.
//  Copyright Â© 2019 rroberts. All rights reserved.
//

#import <XCTest/XCTest.h>
#include "psautohint.h"

@interface Tests : XCTestCase

@end

@implementation Tests

- (NSString *)autohintFontInfo:(NSString *)fontInfo bezString:(NSString *)bezString {
    
    NSString *resultString = nil;
#ifdef DEBUG
    NSDate *startdate = [NSDate date];
#endif
    ACBuffer* output;
    const char* bezdata = [bezString UTF8String];
    const char* fontinfo = [fontInfo UTF8String];         /* the string of fontinfo data */
    bool allowEdit, roundCoords, allowHintSub;
    allowEdit = allowHintSub = roundCoords = true;
    allowEdit = false;
    roundCoords = false;
    
    output = ACBufferNew(4 * strlen(bezdata));
    
    int result = AutoHintString(bezdata, fontinfo, output, allowEdit, allowHintSub, roundCoords);
    
    if (result == AC_Success) {
        char *data = nil;
        size_t length = 0;
        ACBufferRead(output, &data, &length);
        resultString = [NSString stringWithCString:data encoding:NSASCIIStringEncoding];
    }
    
    ACBufferFree(output);
    output = NULL;
    return resultString;
}

- (void)testSimple {
    NSString *fontInfo = @"OrigEmSqUnits 1000 FontName Default AscenderHeight 641 AscenderOvershoot 1 FigHeight 456 FigOvershoot 1 LcHeight 431 LcOvershoot 1 BaselineYCoord 0 BaselineOvershoot -1 DescenderHeight -186 DescenderOvershoot -1 DominantV [14] StemSnapV [14 14] DominantH [12] StemSnapH [12 12] FlexOK true";
    NSString *bezString = @"sc\n  464 0 mt\n  479 0 dt\n  269 641 dt\n  255 641 dt\n  400.746 194 dt\n  105.557 194 dt\n  252 641 dt\n  238 641 dt\n  27 0 dt\n  42 0 dt\n  101.626 182 dt\n  404.658 182 dt\n  cp";
    NSString *expectedResult = @"27 452 vstem\n21 -21 hstem\n182 12 hstem\n641 -20 hstem\n464 hmoveto\n15 hlineto\n-210 641 rlineto\n-14 hlineto\n14575 100 div -447 rlineto\n-29519 100 div hlineto\n14644 100 div 447 rlineto\n-14 hlineto\n-211 -641 rlineto\n15 hlineto\n5962 100 div 182 rlineto\n30302 100 div hlineto\nclosepath\nendchar\n";
    NSString *result = [self autohintFontInfo:fontInfo bezString:bezString];
    XCTAssertEqualObjects(result, expectedResult);
}

- (void)testComplex1 {
    NSString *fontInfo = @"OrigEmSqUnits 1000 FontName Default AscenderHeight 500 AscenderOvershoot 16 AscenderHeight 500 AscenderOvershoot 16 LcHeight 215 LcOvershoot 16 BaselineYCoord 0 BaselineOvershoot -16 DescenderHeight -200 DescenderOvershoot -16 FlexOK true";
    NSString *bezString = @"sc\n139 118 mt\n122 26 dt\n105 118 dt\n81 118 dt\n79 -29 dt\n101 -29 dt\n102 31 dt\n114 -29 dt\n131 -29 dt\n142 32 dt\n144 -29 dt\n165 -29 dt\n164 118 dt\ncp\n176 -171 mt\n176 -159 182 -148 198 -150 ct\n212 -151 212 -163 212 -173 ct\n203 -173 dt\n203 -170 204 -165 202 -161 ct\n200 -155 191 -155 188 -160 ct\n184 -165 186 -178 186 -184 ct\n186 -190 184 -202 189 -208 ct\n191 -213 200 -212 202 -206 ct\n204 -202 203 -198 203 -193 ct\n212 -193 dt\n212 -205 211 -219 195 -219 ct\n171 -219 176 -188 176 -171 ct\ncp\n184 -29 mt\n207 -29 dt\n207 43 dt\n233 -29 dt\n251 -29 dt\n251 118 dt\n228 118 dt\n228 48 dt\n203 118 dt\n184 118 dt\ncp\n220 -183 mt\n220 -165 220 -147 240 -150 ct\n260 -151 258 -170 258 -184 ct\n258 -199 259 -219 239 -219 ct\n217 -219 220 -197 220 -183 ct\ncp\n222 408 mt\n222 542 dt\n250 542 dt\n263 542 276 541 282 527 ct\n291 511 291 488 276 477 ct\n267 468 251 470 239 470 ct\n239 408 dt\ncp\n223 306 mt\n223 389 dt\n240 389 dt\n240 300 dt\n240 289 239 274 251 268 ct\n271 262 276 282 276 297 ct\n276 340 dt\n276 389 dt\n295 389 dt\n295 328 dt\n295 305 300 265 272 256 ct\n256 249 233 255 226 273 ct\n223 283 223 293 223 306 ct\ncp\n230 -178 mt\n230 -185 226 -207 234 -210 ct\n249 -218 248 -196 248 -187 ct\n248 -180 250 -161 243 -158 ct\n234 -153 230 -161 230 -168 ct\n229 -171 230 -175 230 -178 ct\ncp\n239 484 mt\n246 484 252 483 259 485 ct\n268 487 270 495 270 504 ct\n270 513 270 524 259 527 ct\n252 529 246 528 239 528 ct\ncp\n246 -133 mt\n246 -65 dt\n272 -65 dt\n272 -72 dt\n256 -72 dt\n256 -95 dt\n268 -95 dt\n268 -101 dt\n256 -101 dt\n256 -133 dt\ncp\n267 -218 mt\n267 -150 dt\n278 -150 dt\n290 -205 dt\n301 -150 dt\n310 -150 dt\n311 -218 dt\n304 -218 dt\n304 -168 dt\n293 -218 dt\n286 -218 dt\n275 -168 dt\n275 -218 dt\ncp\n267 -29 mt\n292 -29 dt\n292 -2 dt\n267 -2 dt\ncp\n278 -97 mt\n278 -81 278 -63 298 -64 ct\n317 -66 316 -86 316 -100 ct\n316 -114 316 -134 297 -134 ct\n276 -134 278 -112 278 -97 ct\ncp\n287 -95 mt\n287 -101 283 -123 293 -127 ct\n308 -133 306 -112 306 -102 ct\n306 -95 309 -76 301 -73 ct\n293 -68 287 -76 287 -84 ct\ncp\n301 408 mt\n301 542 dt\n352 542 dt\n352 528 dt\n319 528 dt\n319 484 dt\n346 484 dt\n346 470 dt\n319 470 dt\n319 421 dt\n353 421 dt\n353 408 dt\ncp\n302 23 mt\n302 10 303 -2 308 -13 ct\n314 -27 329 -33 343 -31 ct\n359 -27 368 -14 369 -1 ct\n371 18 365 34 351 48 ct\n340 61 dt\n335 66 329 70 326 78 ct\n324 84 325 98 336 97 ct\n346 95 344 78 345 69 ct\n368 70 dt\n368 88 366 109 349 117 ct\n328 126 304 113 303 91 ct\n301 79 303 66 309 57 ct\n311 52 318 48 323 42 ct\n331 32 345 21 345 5 ct\n345 -1 344 -6 339 -7 ct\n335 -9 332 -6 330 -2 ct\n325 6 325 15 325 24 ct\ncp\n309 292 mt\n327 297 dt\n328 289 328 279 334 273 ct\n339 267 349 266 355 272 ct\n363 278 361 291 356 298 ct\n352 303 348 309 341 313 ct\n333 321 321 329 315 339 ct\n304 356 309 383 330 389 ct\n340 391 353 390 363 384 ct\n371 378 374 366 374 356 ct\n360 350 dt\n359 360 356 373 345 375 ct\n336 377 329 372 328 364 ct\n323 349 338 340 349 331 ct\n361 321 373 312 376 295 ct\n380 274 367 254 345 254 ct\n323 254 310 271 309 292 ct\ncp\n323 -218 mt\n323 -150 dt\n333 -150 dt\n345 -205 dt\n357 -150 dt\n366 -150 dt\n367 -218 dt\n361 -218 dt\n360 -168 dt\n348 -218 dt\n341 -218 dt\n331 -168 dt\n330 -218 dt\ncp\n325 -133 mt\n325 -65 dt\n333 -65 343 -63 350 -67 ct\n361 -73 364 -95 350 -100 ct\n361 -133 dt\n350 -133 dt\n341 -101 dt\n334 -101 dt\n334 -133 dt\ncp\n332 153 mt\n332 223 dt\n341 223 358 225 364 216 ct\n366 208 366 195 361 190 ct\n354 185 348 186 341 186 ct\n341 153 dt\ncp\n334 -95 mt\n342 -95 350 -94 350 -83 ct\n350 -73 343 -72 334 -72 ct\ncp\n341 192 mt\n344 192 349 192 351 193 ct\n356 196 356 201 356 206 ct\n356 217 350 217 341 217 ct\ncp\n367 408 mt\n367 542 dt\n384 542 405 544 420 537 ct\n439 525 441 483 419 475 ct\n436 408 dt\n419 408 dt\n401 471 dt\n387 471 dt\n387 408 dt\ncp\n373 153 mt\n373 223 dt\n381 223 dt\n381 161 dt\n399 161 dt\n399 153 dt\ncp\n378 -218 mt\n378 -150 dt\n405 -150 dt\n405 -157 dt\n388 -157 dt\n388 -178 dt\n402 -178 dt\n402 -185 dt\n388 -185 dt\n388 -212 dt\n405 -212 dt\n405 -218 dt\ncp\n380 45 mt\n380 31 379 18 381 4 ct\n382 -7 386 -21 396 -26 ct\n406 -33 423 -33 432 -24 ct\n433 -29 dt\n452 -29 dt\n452 48 dt\n414 48 dt\n414 26 dt\n429 26 dt\n429 18 431 -14 414 -7 ct\n403 -4 406 16 406 24 ct\n406 59 dt\n406 68 405 81 406 92 ct\n409 94 414 98 419 97 ct\n423 95 426 93 426 88 ct\n427 81 427 74 427 66 ct\n451 66 dt\n451 82 452 105 435 115 ct\n426 121 413 121 402 118 ct\n389 113 383 100 381 88 ct\n379 74 380 59 380 45 ct\ncp\n383 -72 mt\n383 -65 dt\n418 -65 dt\n418 -72 dt\n405 -72 dt\n405 -133 dt\n395 -133 dt\n395 -72 dt\ncp\n387 484 mt\n392 484 399 484 406 485 ct\n414 489 417 498 415 508 ct\n415 516 414 523 406 526 ct\n399 529 392 528 387 528 ct\ncp\n392 256 mt\n392 389 dt\n444 389 dt\n444 374 dt\n410 374 dt\n410 331 dt\n437 331 dt\n437 317 dt\n410 317 dt\n410 267 dt\n444 267 dt\n444 256 dt\ncp\n406 153 mt\n406 223 dt\n432 223 dt\n432 217 dt\n414 217 dt\n414 193 dt\n429 193 dt\n429 186 dt\n414 186 dt\n414 161 dt\n432 161 dt\n432 153 dt\ncp\n412 -218 mt\n412 -150 dt\n421 -150 431 -148 438 -152 ct\n448 -158 449 -180 437 -184 ct\n447 -218 dt\n438 -218 dt\n430 -185 dt\n422 -185 dt\n422 -218 dt\ncp\n422 -178 mt\n431 -178 437 -178 437 -168 ct\n437 -158 431 -157 422 -157 ct\ncp\n422 -133 mt\n422 -65 dt\n431 -65 dt\n431 -95 dt\n448 -95 dt\n448 -65 dt\n459 -65 dt\n459 -133 dt\n448 -133 dt\n448 -101 dt\n431 -101 dt\n431 -133 dt\ncp\n436 153 mt\n451 223 dt\n461 223 dt\n475 153 dt\n465 153 dt\n462 172 dt\n447 172 dt\n445 153 dt\ncp\n448 178 mt\n461 178 dt\n456 210 dt\ncp\n448 445 mt\n466 450 dt\n467 440 468 431 473 426 ct\n479 420 489 419 495 425 ct\n502 430 501 443 495 451 ct\n492 455 488 460 480 466 ct\n473 473 461 481 455 490 ct\n444 509 448 536 470 541 ct\n479 544 494 543 502 537 ct\n511 531 513 519 514 509 ct\n500 504 dt\n498 513 496 526 485 529 ct\n476 529 468 525 467 518 ct\n464 502 478 492 489 484 ct\n500 473 512 463 516 448 ct\n520 426 507 407 485 407 ct\n462 407 449 424 448 445 ct\ncp\n456 -171 mt\n456 -159 461 -148 476 -150 ct\n490 -151 491 -163 491 -173 ct\n481 -173 dt\n481 -170 483 -165 480 -161 ct\n479 -155 470 -155 467 -160 ct\n462 -165 464 -178 464 -184 ct\n464 -190 462 -202 467 -208 ct\n470 -213 479 -212 480 -206 ct\n483 -202 481 -198 481 -193 ct\n491 -193 dt\n491 -205 489 -219 473 -219 ct\n449 -219 456 -188 456 -171 ct\ncp\n457 -47 mt\n478 -47 dt\n520 137 dt\n497 137 dt\ncp\n469 -133 mt\n469 -65 dt\n495 -65 dt\n495 -72 dt\n479 -72 dt\n479 -95 dt\n493 -95 dt\n493 -101 dt\n479 -101 dt\n479 -128 dt\n495 -128 dt\n495 -133 dt\ncp\n479 173 mt\n489 176 dt\n489 171 489 163 494 161 ct\n501 160 505 163 505 169 ct\n505 178 494 185 489 191 ct\n480 198 475 211 485 220 ct\n490 223 498 224 503 222 ct\n510 219 513 211 513 205 ct\n505 204 dt\n504 208 503 213 500 217 ct\n495 218 490 217 489 211 ct\n487 204 494 198 498 193 ct\n504 189 512 184 513 176 ct\n517 164 510 153 498 153 ct\n487 153 480 162 479 173 ct\ncp\n494 310 mt\n494 328 492 349 496 367 ct\n501 383 513 389 528 389 ct\n545 390 558 385 563 371 ct\n571 353 566 330 566 313 ct\n566 301 568 291 565 281 ct\n562 263 549 254 531 254 ct\n512 254 498 264 495 282 ct\n494 291 494 300 494 310 ct\ncp\n501 -218 mt\n501 -150 dt\n510 -150 dt\n510 -218 dt\ncp\n513 297 mt\n513 287 512 274 521 270 ct\n527 267 534 267 538 270 ct\n545 273 547 281 548 287 ct\n549 291 548 297 548 301 ct\n548 349 dt\n548 357 549 365 543 371 ct\n538 375 531 377 527 375 ct\n519 374 516 371 513 363 ct\n511 350 513 334 513 321 ct\ncp\n517 -218 mt\n531 -150 dt\n541 -150 dt\n556 -218 dt\n547 -218 dt\n545 -200 dt\n530 -200 dt\n527 -218 dt\ncp\n521 153 mt\n521 223 dt\n548 223 dt\n548 217 dt\n531 217 dt\n531 193 dt\n545 193 dt\n545 186 dt\n531 186 dt\n531 161 dt\n549 161 dt\n549 153 dt\ncp\n524 -133 mt\n524 -65 dt\n550 -65 dt\n550 -72 dt\n531 -72 dt\n531 -95 dt\n545 -95 dt\n545 -101 dt\n531 -101 dt\n531 -133 dt\ncp\n529 461 mt\n529 480 527 502 531 520 ct\n535 536 548 542 563 543 ct\n578 543 593 538 599 523 ct\n605 506 602 483 602 465 ct\n602 454 602 443 600 434 ct\n596 415 584 407 565 407 ct\n545 407 533 417 530 436 ct\n529 444 529 453 529 461 ct\ncp\n531 -195 mt\n543 -195 dt\n537 -163 dt\ncp\n548 449 mt\n548 440 547 427 558 422 ct\n562 420 570 420 574 422 ct\n582 426 583 433 584 440 ct\n584 501 dt\n584 509 584 518 578 523 ct\n573 529 568 529 562 528 ct\n555 527 551 523 549 516 ct\n545 504 548 486 548 473 ct\ncp\n556 -117 mt\n555 -112 556 -106 556 -101 ct\n556 -65 dt\n564 -65 dt\n564 -95 dt\n564 -103 561 -128 573 -128 ct\n586 -128 584 -103 584 -95 ct\n584 -65 dt\n591 -65 dt\n591 -96 dt\n591 -107 595 -128 582 -133 ct\n569 -137 558 -130 556 -117 ct\ncp\n563 -218 mt\n563 -150 dt\n572 -150 dt\n572 -212 dt\n590 -212 dt\n590 -218 dt\ncp\n572 223 mt\n582 223 dt\n591 173 dt\n602 223 dt\n610 223 dt\n596 153 dt\n587 153 dt\ncp\n586 256 mt\n586 389 dt\n598 389 dt\n636 300 dt\n636 389 dt\n653 389 dt\n653 256 dt\n640 256 dt\n600 346 dt\n600 256 dt\ncp\n602 -133 mt\n602 -65 dt\n612 -65 dt\n612 -128 dt\n628 -128 dt\n628 -133 dt\ncp\n613 -150 mt\n621 -150 dt\n632 -200 dt\n642 -150 dt\n651 -150 dt\n635 -218 dt\n628 -218 dt\ncp\n618 153 mt\n618 223 dt\n628 223 dt\n628 153 dt\ncp\n621 408 mt\n621 542 dt\n633 542 dt\n670 453 dt\n670 542 dt\n686 542 dt\n686 408 dt\n674 408 dt\n636 498 dt\n636 408 dt\ncp\n635 -133 mt\n635 -65 dt\n645 -65 dt\n645 -128 dt\n662 -128 dt\n662 -133 dt\ncp\n637 173 mt\n646 176 dt\n646 171 648 163 653 161 ct\n658 160 662 163 662 169 ct\n663 178 653 185 646 191 ct\n638 198 632 211 642 220 ct\n648 223 656 224 661 222 ct\n667 219 669 211 670 205 ct\n662 204 dt\n661 208 661 213 656 217 ct\n654 218 648 217 647 211 ct\n642 204 652 198 656 193 ct\n661 189 669 184 670 176 ct\n673 164 667 153 655 153 ct\n642 153 638 162 637 173 ct\ncp\n658 -218 mt\n658 -150 dt\n685 -150 dt\n685 -157 dt\n668 -157 dt\n668 -178 dt\n682 -178 dt\n682 -185 dt\n668 -185 dt\n668 -212 dt\n685 -212 dt\n685 -218 dt\ncp\n673 256 mt\n673 389 dt\n691 389 dt\n691 267 dt\n725 267 dt\n725 256 dt\ncp\n679 153 mt\n679 223 dt\n689 223 dt\n689 153 dt\ncp\n685 -133 mt\n698 -65 dt\n709 -65 dt\n724 -133 dt\n714 -133 dt\n711 -116 dt\n697 -116 dt\n693 -133 dt\ncp\n692 -218 mt\n692 -150 dt\n701 -150 711 -148 719 -152 ct\n728 -158 730 -180 719 -184 ct\n727 -218 dt\n719 -218 dt\n710 -185 dt\n702 -185 dt\n702 -218 dt\ncp\n695 217 mt\n695 223 dt\n727 223 dt\n727 217 dt\n716 217 dt\n716 153 dt\n708 153 dt\n708 217 dt\ncp\n698 -109 mt\n710 -109 dt\n704 -78 dt\ncp\n700 408 mt\n728 542 dt\n747 542 dt\n775 408 dt\n757 408 dt\n751 440 dt\n724 440 dt\n717 408 dt\ncp\n702 -178 mt\n711 -178 717 -178 717 -168 ct\n717 -158 711 -157 702 -157 ct\ncp\n726 454 mt\n749 454 dt\n738 516 dt\ncp\n730 -133 mt\n730 -65 dt\n736 -65 dt\n756 -110 dt\n756 -65 dt\n764 -65 dt\n764 -133 dt\n757 -133 dt\n739 -87 dt\n739 -133 dt\ncp\n730 389 mt\n747 389 dt\n767 325 dt\n787 389 dt\n805 389 dt\n787 333 dt\n778 306 dt\n775 300 777 293 777 288 ct\n777 256 dt\n758 256 dt\n758 283 dt\n758 289 759 297 758 303 ct\n756 313 753 321 749 329 ct\ncp\n734 -199 mt\n743 -197 dt\n743 -201 744 -208 749 -210 ct\n756 -213 760 -209 760 -203 ct\n760 -195 749 -187 743 -183 ct\n735 -174 730 -160 740 -153 ct\n746 -149 754 -148 759 -151 ct\n765 -153 767 -160 767 -167 ct\n760 -170 dt\n759 -165 759 -159 755 -157 ct\n750 -155 746 -157 744 -161 ct\n741 -168 749 -173 754 -178 ct\n759 -184 767 -188 767 -198 ct\n771 -208 765 -219 753 -219 ct\n741 -219 735 -210 734 -199 ct\ncp\n775 -133 mt\n775 -65 dt\n783 -65 796 -63 805 -70 ct\n812 -76 809 -90 809 -100 ct\n809 -109 812 -124 802 -129 ct\n795 -135 782 -133 775 -133 ct\ncp\n777 -218 mt\n777 -150 dt\n785 -150 dt\n785 -218 dt\ncp\n784 -128 mt\n792 -128 798 -128 800 -117 ct\n800 -82 dt\n799 -72 793 -72 784 -72 ct\ncp\n789 408 mt\n789 542 dt\n808 542 dt\n808 421 dt\n842 421 dt\n842 408 dt\ncp\n795 -183 mt\n795 -165 795 -147 817 -150 ct\n836 -151 833 -170 833 -184 ct\n833 -199 835 -219 815 -219 ct\n794 -219 795 -197 795 -183 ct\ncp\n807 -178 mt\n807 -185 802 -207 810 -210 ct\n825 -218 824 -196 824 -187 ct\n824 -180 826 -161 820 -158 ct\n810 -153 807 -161 807 -168 ct\ncp\n815 256 mt\n815 274 dt\n833 274 dt\n833 256 dt\ncp\n815 389 mt\n833 389 dt\n827 284 dt\n821 284 dt\ncp\n844 -218 mt\n844 -150 dt\n850 -150 dt\n870 -196 dt\n870 -150 dt\n878 -150 dt\n878 -218 dt\n871 -218 dt\n850 -171 dt\n850 -218 dt\ncp";
    NSString *expectedResult = @"27 452 vstem\n21 -21 hstem\n182 12 hstem\n641 -20 hstem\n464 hmoveto\n15 hlineto\n-210 641 rlineto\n-14 hlineto\n14575 100 div -447 rlineto\n-29519 100 div hlineto\n14644 100 div 447 rlineto\n-14 hlineto\n-211 -641 rlineto\n15 hlineto\n5962 100 div 182 rlineto\n30302 100 div hlineto\nclosepath\nendchar\n";
    NSString *result = [self autohintFontInfo:fontInfo bezString:bezString];
    XCTAssertEqualObjects(result, expectedResult);
}

- (void)testPerformanceExample {
    [self measureBlock:^{
        
    }];
}

@end
